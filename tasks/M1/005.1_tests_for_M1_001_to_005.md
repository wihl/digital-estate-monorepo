# Task M1-005_1: Add unit/contract tests for M1-001 through M1-005

## Goal
Create a minimal but persistent pytest suite that covers Tasks M1-001..M1-005:
- backend health endpoint
- config get/set persistence
- archive root validation + bootstrap (creates required dirs; rejects unwritable roots)
- safe-write behavior + startup temp cleanup behavior

This task should make future regressions obvious and prevent re-learning “tribal knowledge”.

## Scope
- Add/enable pytest test harness for the backend (in Docker).
- Add tests for:
  - M1-001: GET /health
  - M1-003: GET /config and POST /config/archive-root persistence
  - M1-004: archive root bootstrap creates required dirs (e.g., people/) and rejects unwritable roots
  - M1-005: safe_write_text writes atomically-ish (temp then rename) and cleanup removes orphan temp files

## Non-goals
- No frontend tests.
- No photo import or recordings tests.
- No full coverage mandate; just high-value contract tests and key filesystem unit tests.
- Don’t redesign architecture; allow small refactors ONLY if necessary to make tests deterministic.

## Context / Constraints
- Tests must run inside the backend container via the existing Makefile target:
  - `make test` runs `docker compose exec backend pytest`
- Tests must not write to the real user home directory.
- SQLite/index work is out of scope here; focus on tasks 1–5 only.
- Must respect INVARIANTS.md: filesystem is source of truth, safe writes, ExFAT constraints.

## Implementation Notes (important)
To make tests deterministic, the backend must allow overriding:
- config directory / config file location
- archive root path

If the code doesn’t already support it, add minimal overrides via environment variables such as:
- `DIGITAL_ESTATE_CONFIG_DIR` (or similar)
- `DIGITAL_ESTATE_ARCHIVE_ROOT` (optional)
These changes are permitted if required to test reliably.

## Steps
1) Add pytest scaffolding in backend:
   - `backend/tests/`
   - `backend/tests/conftest.py`
   - ensure `pytest` and any deps (e.g., `httpx`, `pytest`) are in backend container requirements
   - add `pytest.ini` (or pyproject config) to set test discovery and reduce noise

2) Add FastAPI TestClient fixtures:
   - `client` fixture using `fastapi.testclient.TestClient(app)`
   - `tmp_config_dir` fixture (pytest tmp_path)
   - `tmp_archive_root` fixture (pytest tmp_path) representing an ExFAT-mounted root (we simulate it; don’t require actual ExFAT)

3) Tests for M1-001:
   - `test_health_ok`: GET `/health` returns 200 and expected JSON.

4) Tests for M1-003 (config endpoints):
   - `test_config_initially_null`: GET `/config` returns archive_root null when no config exists
   - `test_set_archive_root_persists`: POST `/config/archive-root` with a tmp dir, then restart app instance OR re-create client, then GET `/config` returns the same path
   - `test_set_archive_root_rejects_missing_path`: POST with non-existent path returns 400

   Note: for “restart,” simplest is: create new TestClient after setting env var pointing at same temp config dir.

5) Tests for M1-004 (bootstrap + validation):
   - `test_set_archive_root_creates_people_dir`: POST archive-root to empty tmp dir, assert `<root>/people` exists after call
   - `test_set_archive_root_requires_writable`: make tmp dir read-only, POST should return 400 with clear error

   Note: “read-only dir” on mac/linux: `chmod 555` and ensure test is robust; if running as root in container, you may need another strategy:
   - create a directory owned by root but run pytest as non-root OR
   - simulate by pointing to a file path OR
   - adjust validation to check writability by attempting to create a temp file in root (preferred behavior anyway)

6) Tests for M1-005 (safe-write + cleanup):
   - Unit test `safe_write_text`:
     - write initial content to file
     - call safe_write_text(new_content)
     - assert file content == new_content
     - assert no leftover temp files matching your temp pattern remain in directory
   - Cleanup test:
     - create fake orphan temp file(s) in archive root (e.g., `*.tmp` / `.tmp-*`—match your implementation)
     - run the cleanup function
     - assert orphan temp files removed (or quarantined) per current behavior

7) Wire Makefile “test” target expectations:
   - Ensure `make test` exits non-zero if pytest fails (remove `|| echo ...` fallback once tests exist)
   - If you still want a friendly message, print it before running pytest, but don’t swallow failure.

## Acceptance checks (must pass)
- `make test` succeeds and runs the new tests.
- Tests do NOT write to real home dir (verify by running tests twice and checking no new files in ~/Library/Application Support/... on the host).
- The following tests exist and pass:
  - `test_health_ok`
  - `test_config_initially_null`
  - `test_set_archive_root_persists`
  - `test_set_archive_root_creates_people_dir`
  - `test_safe_write_text_no_tmp_leftovers`
  - `test_cleanup_orphan_tmp_files`

## Definition of Done
- [ ] New tests exist for M1-001..M1-005 behaviors
- [ ] `make test` fails on test failure (no swallowing)
- [ ] Any required env var overrides are documented in README or DECISIONS.md
- [ ] No unrelated refactors
- [ ] Task file marked complete in the same commit as the test additions
